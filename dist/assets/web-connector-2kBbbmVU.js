const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/in-app-wallet-calls-Dl5w4L9t.js","assets/vendor-thirdweb-B1z45yR6.js"])))=>i.map(i=>d[i]);
import{M as h,q as w,s as p,N as X,f as k,g as y,_ as b,O as Z,P,Q as M,p as z,R as W,i as ee,S as v,T as $,U as te}from"./vendor-thirdweb-B1z45yR6.js";import{p as G,w as x}from"./Auth-D--Fh304.js";import{a as ne}from"./types-CY5aNEio.js";import"./vendor-ui-DPGpZYCr.js";import"./vendor-react-CpsyMv2-.js";import"./index-Dy8cuphJ.js";import"./mail-2b8o2FGV.js";import"./eye-off-5dQQKzLU.js";import"./eye-CStPiHBG.js";import"./circle-alert-BjoSExI5.js";import"./loader-circle-C2IDBDno.js";const ie="/sdk/2022-08-12/embedded-wallet",A=n=>`thirdwebEwsWalletUserId-${n}`,ae="walletToken",T=n=>`${ae}-${n}`,j=n=>`passkey-credential-id-${n}`,re="a",E=(n,e)=>`${re}-${n}-${e}`,D=n=>`walletConnectSessions-${n}`,U=n=>`thirdweb_guest_session_id_${n}`,F=new Map;class V{constructor({storage:e,clientId:t,ecosystem:i}){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.storage=e,this.key=se(t,i==null?void 0:i.id),this.ecosystem=i}async getItem(e){return this.storage?this.storage.getItem(e):F.get(e)??null}async setItem(e,t){if(this.storage)return this.storage.setItem(e,t);F.set(e,t)}async removeItem(e){const t=await this.getItem(e);return this.storage&&t?(this.storage.removeItem(e),!0):!1}async getWalletConnectSessions(){return this.getItem(D(this.key))}async saveWalletConnectSessions(e){await this.setItem(D(this.key),e)}async savePasskeyCredentialId(e){await this.setItem(j(this.key),e)}async getPasskeyCredentialId(){return this.getItem(j(this.key))}async saveAuthCookie(e){await this.setItem(T(this.key),e)}async getAuthCookie(){return this.getItem(T(this.key))}async removeAuthCookie(){return this.removeItem(T(this.key))}async saveDeviceShare(e,t){await this.saveWalletUserId(t),await this.setItem(E(this.key,t),e)}async getDeviceShare(){const e=await this.getWalletUserId();return e?this.getItem(E(this.key,e)):null}async removeDeviceShare(){const e=await this.getWalletUserId();return e?this.removeItem(E(this.key,e)):!1}async getWalletUserId(){return this.getItem(A(this.key))}async saveWalletUserId(e){await this.setItem(A(this.key),e)}async removeWalletUserId(){return this.removeItem(A(this.key))}async getGuestSessionId(){return this.getItem(U(this.key))}async saveGuestSessionId(e){await this.setItem(U(this.key),e)}}const se=(n,e)=>`${n}${e?`-${e}`:""}`,L=new Map,oe={getItem:async n=>L.get(n)??null,removeItem:async n=>{L.delete(n)},setItem:async(n,e)=>{L.set(n,e)}};async function O({authToken:n,client:e,ecosystem:t}){const r=await h(e,t)(`${w("inAppWallet")}/api/2024-05-05/accounts`,{headers:{Authorization:`Bearer embedded-wallet-token:${n}`,"Content-Type":"application/json"},method:"GET"});if(!r.ok){const c=await r.text().catch(()=>"Unknown error");throw new Error(`Failed to get user info: ${c}`)}return await r.json()}const ce=w("inAppWallet"),le=`${ce}/`,q=`${le}api/2023-10-20`,ue=`${q}/embedded-wallet/validate-custom-jwt`,de=`${q}/embedded-wallet/validate-custom-auth-endpoint`,H=(n,e)=>e instanceof Error?`${n}: ${e.message}`:`${n}: ${p(e)}`;async function he(n){const t=await h(n.client,n.ecosystem)(de,{body:p({developerClientId:n.client.clientId,payload:n.payload}),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok){const i=await t.json();throw new Error(`Custom auth endpoint authentication error: ${i.message}`)}try{const{verifiedToken:i}=await t.json();return{storedToken:i}}catch(i){throw new Error(H("Malformed response from post auth_endpoint authentication",i))}}const Q=n=>{if(!ne.includes(n))throw new Error(`Unknown auth option ${n}`);switch(n){case"wallet":return"siwe";default:return n}},I=({authOption:n,client:e,ecosystem:t,mode:i="popup",redirectUrl:r})=>{if(i==="popup"&&r)throw new Error("Redirect URL is not supported for popup mode");if(i==="window"&&!r)throw new Error("Redirect URL is required for window mode");const c=Q(n);let s=`${w("inAppWallet")}/api/2024-05-05/login/${c}?clientId=${e.clientId}`;if(t!=null&&t.partnerId?s=`${s}&ecosystemId=${t.id}&ecosystemPartnerId=${t.partnerId}`:t&&(s=`${s}&ecosystemId=${t.id}`),i!=="popup"){const a=new URL(r||window.location.href);a.searchParams.set("walletId",(t==null?void 0:t.id)||"inApp"),a.searchParams.set("authProvider",n),s=`${s}&redirectUrl=${encodeURIComponent(a.toString())}`}return s},C=({authOption:n,client:e,ecosystem:t})=>{const i=Q(n);let r=`${w("inAppWallet")}/api/2024-05-05/login/${i}/callback?clientId=${e.clientId}`;return t!=null&&t.partnerId?r=`${r}&ecosystemId=${t.id}&ecosystemPartnerId=${t.partnerId}`:t&&(r=`${r}&ecosystemId=${t.id}`),r};async function we(n){const e=h(n.client,n.ecosystem),t=I({authOption:"backend",client:n.client,ecosystem:n.ecosystem}),i=await e(`${t}`,{body:p({walletSecret:n.walletSecret}),headers:{"Content-Type":"application/json"},method:"POST"});if(!i.ok){const r=await i.text();throw new Error(`Failed to generate backend account: ${r}`)}return await i.json()}async function pe(n){let e=await n.storage.getGuestSessionId();e||(e=X(32),n.storage.saveGuestSessionId(e));const t=h(n.client,n.ecosystem),i=C({authOption:"guest",client:n.client,ecosystem:n.ecosystem}),r=await t(`${i}`,{body:p({sessionId:e}),headers:{"Content-Type":"application/json"},method:"POST"});if(!r.ok){const c=await r.text();throw new Error(`Failed to generate guest account: ${r.status} ${r.statusText} ${c}`)}return await r.json()}async function ge(n){const t=await h(n.client,n.ecosystem)(ue,{body:p({developerClientId:n.client.clientId,jwt:n.jwt}),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok){const i=await t.json();throw new Error(`JWT authentication error: ${i.message}`)}try{const{verifiedToken:i}=await t.json();return{storedToken:i}}catch(i){throw new Error(H("Malformed response from post jwt authentication",i))}}async function me({client:n,ecosystem:e,tokenToLink:t,storage:i}){const r=h(n,e),c=w("inAppWallet"),s=await i.getAuthCookie();if(!s)throw new Error("Failed to link account, no user logged in");const a={Authorization:`Bearer iaw-auth-token:${s}`,"Content-Type":"application/json"},l=await r(`${c}/api/2024-05-05/account/connect`,{body:p({accountAuthTokenToConnect:t}),headers:a,method:"POST"});if(!l.ok){const u=await l.json();throw new Error(u.message||"Failed to link account.")}const{linkedAccounts:o}=await l.json();return o??[]}async function fe({client:n,ecosystem:e,profileToUnlink:t,allowAccountDeletion:i=!1,storage:r}){const c=h(n,e),s=w("inAppWallet"),a=await r.getAuthCookie();if(!a)throw new Error("Failed to unlink account, no user logged in");const l={Authorization:`Bearer iaw-auth-token:${a}`,"Content-Type":"application/json"},o=await c(`${s}/api/2024-05-05/account/disconnect`,{body:p({allowAccountDeletion:i,details:t.details,type:t.type}),headers:l,method:"POST"});if(!o.ok){const d=await o.json();throw new Error(d.message||"Failed to unlink account.")}const{linkedAccounts:u}=await o.json();return u??[]}async function ye({client:n,ecosystem:e,storage:t}){const i=h(n,e),r=w("inAppWallet"),c=await t.getAuthCookie();if(!c)throw new Error("Failed to get linked accounts, no user logged in");const s={Authorization:`Bearer iaw-auth-token:${c}`,"Content-Type":"application/json"},a=await i(`${r}/api/2024-05-05/accounts`,{headers:s,method:"GET"});if(!a.ok){const o=await a.json();throw new Error(o.message||"Failed to get linked accounts.")}const{linkedAccounts:l}=await a.json();return l??[]}function J(){return`${w("inAppWallet")}/api/2024-05-05/login/passkey/callback`}function K(n,e){return`${w("inAppWallet")}/api/2024-05-05/login/passkey?type=${n}${e?`&username=${e}`:""}`}async function Ie(n){var u,d,g;if(!n.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=h(n.client,n.ecosystem),t=n.username??ke(n.ecosystem),r=await(await e(K("sign-up",t))).json();if(!r.challenge)throw new Error("No challenge received");const c=r.challenge,s=await n.passkeyClient.register({challenge:c,name:t,rp:n.rp}),a={};(u=n.ecosystem)!=null&&u.partnerId&&(a["x-ecosystem-partner-id"]=n.ecosystem.partnerId),(d=n.ecosystem)!=null&&d.id&&(a["x-ecosystem-id"]=n.ecosystem.id);const o=await(await e(J(),{body:p({authenticatorData:s.authenticatorData,clientData:s.clientData,credential:{algorithm:s.credential.algorithm,publicKey:s.credential.publicKey},credentialId:s.credentialId,origin:s.origin,rpId:n.rp.id,serverVerificationId:r.serverVerificationId,type:"sign-up",username:t}),headers:{"Content-Type":"application/json",...a},method:"POST"})).json();if(!o||!o.storedToken)throw new Error(`Error verifying passkey: ${o.message??"unknown error"}`);return await((g=n.storage)==null?void 0:g.savePasskeyCredentialId(s.credentialId)),o}async function be(n){var o,u,d,g;if(!n.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=h(n.client,n.ecosystem),[t,i]=await Promise.all([e(K("sign-in")).then(f=>f.json()),(o=n.storage)==null?void 0:o.getPasskeyCredentialId()]);if(!t.challenge)throw new Error("No challenge received");const r=t.challenge,c=await n.passkeyClient.authenticate({challenge:r,credentialId:i??void 0,rp:n.rp}),s={};(u=n.ecosystem)!=null&&u.partnerId&&(s["x-ecosystem-partner-id"]=n.ecosystem.partnerId),(d=n.ecosystem)!=null&&d.id&&(s["x-ecosystem-id"]=n.ecosystem.id);const l=await(await e(J(),{body:p({authenticatorData:c.authenticatorData,clientData:c.clientData,credentialId:c.credentialId,origin:c.origin,rpId:n.rp.id,serverVerificationId:t.serverVerificationId,signature:c.signature,type:"sign-in"}),headers:{"Content-Type":"application/json",...s},method:"POST"})).json();if(!l||!l.storedToken)throw new Error(`Error verifying passkey: ${l.message??"unknown error"}`);return await((g=n.storage)==null?void 0:g.savePasskeyCredentialId(c.credentialId)),l}function ke(n){return`${(n==null?void 0:n.id)??"wallet"}-${new Date().toISOString()}`}function ve(n){let i=[`${n.domain} wants you to sign in with your Ethereum account:`,n.address].join(`
`);i=[i,n.statement].join(`

`),n.statement&&(i+=`
`);const r=[];if(n.uri){const u=`URI: ${n.uri}`;r.push(u)}const c=`Version: ${n.version}`;if(r.push(c),n.chain_id){const u=`Chain ID: ${n.chain_id}`||"1";r.push(u)}const s=`Nonce: ${n.nonce}`;r.push(s);const a=`Issued At: ${n.issued_at}`;r.push(a);const l=`Expiration Time: ${n.expiration_time}`;if(r.push(l),n.invalid_before){const u=`Not Before: ${n.invalid_before}`;r.push(u)}n.resources&&r.push(["Resources:",...n.resources.map(u=>`- ${u}`)].join(`
`));const o=r.join(`
`);return[i,o].join(`
`)}async function Ae(n){const{payload:e,account:t}=n,i=await t.signMessage({message:ve(e)});return{payload:e,signature:i}}async function Te(n){const{wallet:e,client:t,ecosystem:i}=n,r=k(1),c=e.getAccount()||await e.connect({chain:r,client:t}),s=h(t,i),a=await(async()=>{const u=I({authOption:"wallet",client:n.client,ecosystem:n.ecosystem}),d=await s(`${u}&address=${c.address}&chainId=${r.id}`);if(!d.ok)throw new Error("Failed to generate SIWE login payload");return await d.json()})(),{signature:l}=await Ae({account:c,payload:a});return await(async()=>{const u=C({authOption:"wallet",client:n.client,ecosystem:n.ecosystem}),d=await s(`${u}&signature=${l}&payload=${encodeURIComponent(a)}`,{body:p({payload:a,signature:l}),headers:{"Content-Type":"application/json"},method:"POST"});if(!d.ok)throw new Error("Failed to verify SIWE signature");return await d.json()})()}async function Ee({client:n,payload:e,storage:t}){const i=await t.getAuthCookie(),r=t.ecosystem,c=h(n,r);if(!i)throw new Error("No auth token found when signing message");const s={address:e.address,chainId:e.chainId,nonce:Number(e.nonce)},a=await c(`${w("inAppWallet")}/api/v1/enclave-wallet/sign-authorization`,{body:p(s),headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!a.ok)throw new Error(`Failed to sign message - ${a.status} ${a.statusText}`);return await a.json()}async function Le({client:n,payload:{message:e,isRaw:t,originalMessage:i,chainId:r},storage:c}){const s=await c.getAuthCookie(),a=c.ecosystem,l=h(n,a);if(!s)throw new Error("No auth token found when signing message");const o=await l(`${w("inAppWallet")}/api/v1/enclave-wallet/sign-message`,{body:p({messagePayload:{chainId:r,isRaw:t,message:e,originalMessage:i}}),headers:{Authorization:`Bearer embedded-wallet-token:${s}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!o.ok)throw new Error(`Failed to sign message - ${o.status} ${o.statusText}`);return await o.json()}async function Se({client:n,payload:e,storage:t}){const i=await t.getAuthCookie(),r=t.ecosystem,c=h(n,r);if(!i)throw new Error("No auth token found when signing transaction");const s=await c(`${w("inAppWallet")}/api/v1/enclave-wallet/sign-transaction`,{body:p({transactionPayload:e}),headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!s.ok)throw new Error(`Failed to sign transaction - ${s.status} ${s.statusText}`);return(await s.json()).signature}async function Pe({client:n,payload:e,storage:t}){const i=await t.getAuthCookie(),r=t.ecosystem,c=h(n,r);if(!i)throw new Error("No auth token found when signing typed data");const s=await c(`${w("inAppWallet")}/api/v1/enclave-wallet/sign-typed-data`,{body:p({...e}),headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!s.ok)throw new Error(`Failed to sign typed data - ${s.status} ${s.statusText}`);return await s.json()}class We{constructor({client:e,ecosystem:t,address:i,storage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"address",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.address=i,this.localStorage=r}async postWalletSetUp(e){await this.localStorage.saveAuthCookie(e.storedToken.cookieString)}async getUserWalletStatus(){var c,s;const e=await this.localStorage.getAuthCookie();if(!e)return{status:"Logged Out"};const t=await O({authToken:e,client:this.client,ecosystem:this.ecosystem});if(!t)return{status:"Logged Out"};const i=t.wallets[0],r={email:(c=t.linkedAccounts.find(a=>a.details.email!==void 0))==null?void 0:c.details.email,phoneNumber:(s=t.linkedAccounts.find(a=>a.details.phone!==void 0))==null?void 0:s.details.phone,recoveryShareManagement:"ENCLAVE",userWalletId:t.id||""};return i?{account:await this.getAccount(),authDetails:r,status:"Logged In, Wallet Initialized",walletAddress:i.address}:{authDetails:r,status:"Logged In, Wallet Uninitialized"}}async getAccount(){const e=this.client,t=this.localStorage,i=this.address,r=this.ecosystem,c=async a=>{const l=P({chain:k(a.chainId),client:e}),o={chainId:W(a.chainId),data:a.data,gas:m(a.gas),nonce:m(a.nonce)||W(await b(async()=>{const{eth_getTransactionCount:u}=await import("./vendor-thirdweb-B1z45yR6.js").then(d=>d.aJ);return{eth_getTransactionCount:u}},[]).then(({eth_getTransactionCount:u})=>u(l,{address:y(this.address),blockTag:"pending"}))),to:a.to?y(a.to):void 0,value:m(a.value)};return a.authorizationList&&a.authorizationList.length>0?(o.type=4,o.authorizationList=a.authorizationList,o.maxFeePerGas=m(a.maxFeePerGas),o.maxPriorityFeePerGas=m(a.maxPriorityFeePerGas)):m(a.maxFeePerGas)?(o.maxFeePerGas=m(a.maxFeePerGas),o.maxPriorityFeePerGas=m(a.maxPriorityFeePerGas),o.type=2):(o.gasPrice=m(a.gasPrice),o.type=0),Se({client:e,payload:o,storage:t})},s={address:y(i),async sendTransaction(a){const l=P({chain:k(a.chainId),client:e}),o=await c(a),u=await M(l,o);return z({chainId:a.chainId,client:e,contractAddress:a.to??void 0,ecosystem:r,gasPrice:a.gasPrice,transactionHash:u,walletAddress:i,walletType:"inApp"}),{transactionHash:u}},async signAuthorization(a){const l=await Ee({client:e,payload:a,storage:t});return{address:y(l.address),chainId:Number.parseInt(l.chainId),nonce:BigInt(l.nonce),r:BigInt(l.r),s:BigInt(l.s),yParity:Number.parseInt(l.yParity)}},async signMessage({message:a,originalMessage:l,chainId:o}){const u=typeof a=="string"?{chainId:o,isRaw:!1,message:a,originalMessage:l}:{chainId:o,isRaw:!0,message:typeof a.raw=="string"?a.raw:Z(a.raw),originalMessage:l},{signature:d}=await Le({client:e,payload:u,storage:t});return d},async signTransaction(a){if(!a.chainId)throw new Error("chainId required in tx to sign");return c({chainId:a.chainId,...a})},async signTypedData(a){const l=G(a),{signature:o}=await Pe({client:e,payload:l,storage:t});return o},sendCalls:async a=>{const{inAppWalletSendCalls:l}=await b(async()=>{const{inAppWalletSendCalls:f}=await import("./in-app-wallet-calls-Dl5w4L9t.js");return{inAppWalletSendCalls:f}},__vite__mapDeps([0,1])),o=a.calls[0];if(!o)throw new Error("No calls to send");const u=o.client,d=o.chain||a.chain,g=await l({account:s,calls:a.calls});return{chain:d,client:u,id:g}},getCallsStatus:async a=>{const{inAppWalletGetCallsStatus:l}=await b(async()=>{const{inAppWalletGetCallsStatus:o}=await import("./in-app-wallet-calls-Dl5w4L9t.js");return{inAppWalletGetCallsStatus:o}},__vite__mapDeps([0,1]));return l(a)},getCapabilities:async a=>({[a.chainId??1]:{atomic:{status:"unsupported"},paymasterService:{supported:!1}}})};return s}}function m(n){return n===void 0||ee(n)?n:W(n)}const Oe={backgroundColor:"transparent",border:"none",colorScheme:"light",display:"none",height:"100%",pointerEvents:"all",position:"fixed",right:"0px",top:"0px",width:"100%",zIndex:"2147483646"},S=new Map;class Ce{constructor({link:e,baseUrl:t,iframeId:i,container:r,onIframeInitialize:c,localStorage:s,clientId:a,ecosystem:l}){if(Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.localStorage=s,this.clientId=a,this.ecosystem=l,this.iframeBaseUrl=t,typeof document>"u")return;r=r??document.body;let o=document.getElementById(i);const u=new URL(e);if(!o||o.src!==u.href){o=document.createElement("iframe");const d={...Oe};Object.assign(o.style,d),o.setAttribute("id",i),o.setAttribute("fetchpriority","high"),r.appendChild(o),o.src=u.href;const g=f=>{if(f.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",g),!o){console.warn("thirdweb iFrame not found");return}this.onIframeLoadHandler(o,c)()}};window.addEventListener("message",g)}this.iframe=o}async onIframeLoadedInitVariables(){var e,t;return{authCookie:await this.localStorage.getAuthCookie(),clientId:this.clientId,deviceShareStored:await this.localStorage.getDeviceShare(),ecosystemId:(e=this.ecosystem)==null?void 0:e.id,partnerId:(t=this.ecosystem)==null?void 0:t.partnerId,walletUserId:await this.localStorage.getWalletUserId()}}onIframeLoadHandler(e,t){return async()=>{var c;const i=new MessageChannel,r=new Promise((s,a)=>{i.port1.onmessage=l=>{const{data:o}=l;i.port1.close(),o.success||a(new Error(o.error)),S.set(e.src,!0),t&&t(),s(!0)}});(c=e==null?void 0:e.contentWindow)==null||c.postMessage({data:await this.onIframeLoadedInitVariables(),eventType:"initIframe"},this.iframeBaseUrl,[i.port2]),await r}}async call({procedureName:e,params:t,showIframe:i=!1}){var s;if(!this.iframe)throw new Error("Iframe not found. You are likely calling this from the backend where the DOM is not available.");for(;!S.get(this.iframe.src);)await v(this.POLLING_INTERVAL_SECONDS*1e3);i&&(this.iframe.style.display="block",await v(.005*1e3));const r=new MessageChannel,c=new Promise((a,l)=>{r.port1.onmessage=async o=>{const{data:u}=o;r.port1.close(),i&&(await v(.1*1e3),this.iframe&&(this.iframe.style.display="none")),u.success?a(u.data):l(new Error(u.error))}});return(s=this.iframe.contentWindow)==null||s.postMessage({data:{...t,...await this.onIframeLoadedInitVariables()},eventType:e},this.iframeBaseUrl,[r.port2]),c}destroy(){this.iframe&&S.delete(this.iframe.src)}}class _e extends Ce{constructor({clientId:e,baseUrl:t,ecosystem:i}){super({baseUrl:t,clientId:e,container:typeof document>"u"?void 0:document.body,ecosystem:i,iframeId:je+((i==null?void 0:i.id)||""),link:$e({baseUrl:t,clientId:e,ecosystem:i,path:ie}).href,localStorage:new V({clientId:e,ecosystem:i,storage:x})}),this.clientId=e,this.ecosystem=i}}function $e({clientId:n,baseUrl:e,path:t,ecosystem:i,queryParams:r}){var s;const c=new URL(`${t}`,e);if(r)for(const a of Object.keys(r))c.searchParams.set(a,((s=r[a])==null?void 0:s.toString())||"");return c.searchParams.set("clientId",n),(i==null?void 0:i.partnerId)!==void 0&&c.searchParams.set("partnerId",i.partnerId),(i==null?void 0:i.id)!==void 0&&c.searchParams.set("ecosystemId",i.id),c}const je="thirdweb-in-app-wallet-iframe";async function De({client:n,ecosystem:e,authToken:t}){const r=await h(n,e)(`${w("inAppWallet")}/api/v1/enclave-wallet/generate`,{headers:{Authorization:`Bearer embedded-wallet-token:${t}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!r.ok)throw new Error(`Failed to generate wallet - ${r.status} ${r.statusText}`);const{wallet:c}=await r.json();return c}class Ue{constructor({baseUrl:e,querier:t,preLogin:i,postLogin:r,client:c,ecosystem:s}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=i,this.postLogin=r,this.client=c,this.ecosystem=s}async sendEmailLoginOtp({email:e}){return await this.LoginQuerier.call({params:{email:e},procedureName:"sendThirdwebEmailLoginOtp"})}async sendSmsLoginOtp({phoneNumber:e}){return await this.LoginQuerier.call({params:{phoneNumber:e},procedureName:"sendThirdwebSmsLoginOtp"})}}class Fe extends Ue{async authenticateWithModal(){return this.LoginQuerier.call({params:void 0,procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithModal(){await this.preLogin();const e=await this.authenticateWithModal();return this.postLogin(e)}async authenticateWithIframe({email:e}){return this.LoginQuerier.call({params:{email:e},procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithIframe({email:e}){await this.preLogin();const t=await this.authenticateWithIframe({email:e});return this.postLogin(t)}async authenticateWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");return this.LoginQuerier.call({params:{encryptionKey:e,jwt:t},procedureName:"loginWithCustomJwt"})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");await this.preLogin();const i=await this.authenticateWithCustomJwt({encryptionKey:e,jwt:t});return this.postLogin(i)}async authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t}){return this.LoginQuerier.call({params:{encryptionKey:e,payload:t},procedureName:"loginWithCustomAuthEndpoint"})}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom auth");await this.preLogin();const i=await this.authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t});return this.postLogin(i)}async authenticateWithEmailOtp({email:e,otp:t,recoveryCode:i}){return this.LoginQuerier.call({params:{email:e,otp:t,recoveryCode:i},procedureName:"verifyThirdwebEmailLoginOtp"})}async loginWithEmailOtp({email:e,otp:t,recoveryCode:i}){const r=await this.authenticateWithEmailOtp({email:e,otp:t,recoveryCode:i});return this.postLogin(r)}async authenticateWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:i}){return this.LoginQuerier.call({params:{otp:t,phoneNumber:e,recoveryCode:i},procedureName:"verifyThirdwebSmsLoginOtp"})}async loginWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:i}){const r=await this.authenticateWithSmsOtp({otp:t,phoneNumber:e,recoveryCode:i});return this.postLogin(r)}}class Ne{constructor({client:e,querier:t,onAuthSuccess:i,ecosystem:r,baseUrl:c,localStorage:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=r,this.AuthQuerier=t,this.localStorage=s,this.onAuthSuccess=i,this.BaseLogin=new Fe({baseUrl:c,client:e,ecosystem:r,postLogin:async a=>this.postLogin(a),preLogin:async()=>{await this.preLogin()},querier:t})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){var c;e.storedToken.authProvider!=="Backend"&&await this.preLogin();const i=await O({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});if(!i)throw new Error("Cannot login, no user found for auth token");if(i.wallets.length>0&&((c=i.wallets[0])==null?void 0:c.type)==="enclave")return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:i.wallets[0].address}});if(i.wallets.length===0){const s=await De({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:s.address}})}const r=await this.AuthQuerier.call({params:{recoveryCode:t,storedToken:e.storedToken},procedureName:"loginWithStoredTokenDetails"});return this.postLogin(r)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async authenticateWithModal(){return this.BaseLogin.authenticateWithModal()}async loginWithIframe(e){return this.BaseLogin.loginWithIframe(e)}async authenticateWithIframe(e){return this.BaseLogin.authenticateWithIframe(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async authenticateWithCustomJwt(e){return this.BaseLogin.authenticateWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async authenticateWithCustomAuthEndpoint(e){return this.BaseLogin.authenticateWithCustomAuthEndpoint(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async loginWithEmailOtp(e){return await this.preLogin(),this.BaseLogin.loginWithEmailOtp(e)}async authenticateWithEmailOtp(e){return this.BaseLogin.authenticateWithEmailOtp(e)}async loginWithSmsOtp(e){return await this.preLogin(),this.BaseLogin.loginWithSmsOtp(e)}async authenticateWithSmsOtp(e){return this.BaseLogin.authenticateWithSmsOtp(e)}async logout(){const e=await this.localStorage.removeAuthCookie(),t=await this.localStorage.removeWalletUserId();return{success:e||t}}}const Re="width=350, height=500",N=({isWindowOpenedByFn:n,win:e,closeOpenedWindow:t})=>{n?e==null||e.close():e&&t?t(e):e&&e.close()};async function Be(n){const e=I({...n,mode:n.mode||"redirect"});n.mode==="redirect"?window.location.href=e:window.open(e),await new Promise(t=>setTimeout(t,5e3))}const Me=async n=>{let e=n.openedWindow,t=!1;if(e||(e=window.open(I({...n,mode:"popup"}),`Login to ${n.authOption}`,Re),t=!0),!e)throw new Error("Something went wrong opening pop-up");return await new Promise((r,c)=>{const s=window.setInterval(async()=>{e.closed&&(clearInterval(s),window.removeEventListener("message",a),c(new Error("User closed login window")))},1e3),a=async l=>{if(l.origin===w("inAppWallet")){if(typeof l.data!="object"){c(new Error("Invalid event data"));return}switch(l.data.eventType){case"oauthSuccessResult":{window.removeEventListener("message",a),clearInterval(s),N({closeOpenedWindow:n.closeOpenedWindow,isWindowOpenedByFn:t,win:e}),l.data.authResult&&r(l.data.authResult);break}case"oauthFailureResult":{window.removeEventListener("message",a),clearInterval(s),N({closeOpenedWindow:n.closeOpenedWindow,isWindowOpenedByFn:t,win:e}),c(new Error(l.data.errorString));break}}}};window.addEventListener("message",a)})},ze=async n=>{const{client:e,ecosystem:t}=n,i=I({authOption:n.strategy,client:e,ecosystem:t}),r={"Content-Type":"application/json","x-client-id":e.clientId};t!=null&&t.id&&(r["x-ecosystem-id"]=t.id),t!=null&&t.partnerId&&(r["x-ecosystem-partner-id"]=t.partnerId);const c=(()=>{switch(n.strategy){case"email":return{email:n.email};case"phone":return{phone:n.phoneNumber}}})(),s=await fetch(i,{body:p(c),headers:r,method:"POST"});if(!s.ok)throw new Error("Failed to send verification code");return await s.json()},R=async n=>{const{client:e,ecosystem:t}=n,i=C({authOption:n.strategy,client:n.client,ecosystem:n.ecosystem}),r={"Content-Type":"application/json","x-client-id":e.clientId};t!=null&&t.id&&(r["x-ecosystem-id"]=t.id),t!=null&&t.partnerId&&(r["x-ecosystem-partner-id"]=t.partnerId);const c=(()=>{switch(n.strategy){case"email":return{code:n.verificationCode,email:n.email};case"phone":return{code:n.verificationCode,phone:n.phoneNumber}}})(),s=await fetch(i,{body:p(c),headers:r,method:"POST"});if(!s.ok)throw new Error("Failed to verify verification code");return await s.json()};class B{constructor({client:e,ecosystem:t,querier:i,localStorage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.walletManagerQuerier=i,this.localStorage=r}async postWalletSetUp(e){e.deviceShareStored&&await this.localStorage.saveDeviceShare(e.deviceShareStored,e.storedToken.authDetails.userWalletId)}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({params:void 0,procedureName:"getUserStatus"});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",...e.user,account:await this.getAccount()}:e.status==="Logged In, New Device"?{status:"Logged In, New Device",...e.user}:e.status==="Logged In, Wallet Uninitialized"?{status:"Logged In, Wallet Uninitialized",...e.user}:{status:e.status}}async getAccount(){var s;const e=this.walletManagerQuerier,t=this.client,i=(s=this.ecosystem)==null?void 0:s.partnerId,{address:r}=await e.call({params:void 0,procedureName:"getAddress"}),c=async a=>{const l={chainId:a.chainId,data:a.data,gasLimit:a.gas,nonce:a.nonce,to:a.to??void 0,value:a.value};a.maxFeePerGas?(l.accessList=a.accessList,l.maxFeePerGas=a.maxFeePerGas,l.maxPriorityFeePerGas=a.maxPriorityFeePerGas,l.type=2):(l.gasPrice=a.gasPrice,l.type=0);const o=$().rpc,{signedTransaction:u}=await e.call({params:{chainId:a.chainId,partnerId:i,rpcEndpoint:`https://${a.chainId}.${o}`,transaction:l},procedureName:"signTransaction"});return u};return{address:y(r),async sendTransaction(a){const l=P({chain:k(a.chainId),client:t}),o=await c(a),u=await M(l,o);return z({chainId:a.chainId,client:t,contractAddress:a.to??void 0,gasPrice:a.gasPrice,transactionHash:u,walletAddress:r,walletType:"inApp"}),{transactionHash:u}},async signMessage({message:a}){const l=typeof a=="string"?a:a.raw instanceof Uint8Array?a.raw:te(a.raw),{signedMessage:o}=await e.call({params:{chainId:1,message:l,partnerId:i},procedureName:"signMessage"});return o},async signTransaction(a){if(!a.chainId)throw new Error("chainId required in tx to sign");return c({...a,chainId:a.chainId})},async signTypedData(a){var _;const l=G(a);(_=l.types)!=null&&_.EIP712Domain&&(l.types.EIP712Domain=void 0);const o=l.domain,u=o==null?void 0:o.chainId,g={...o!=null&&o.verifyingContract?{verifyingContract:o==null?void 0:o.verifyingContract}:{},name:o==null?void 0:o.name,version:o==null?void 0:o.version};u&&(g.chainId=u);const f=$().rpc,{signedTypedData:Y}=await e.call({params:{chainId:Number.parseInt(BigInt(u||1).toString()),domain:g,message:l.message,partnerId:i,rpcEndpoint:`https://${u}.${f}`,types:l.types},procedureName:"signTypedDataV4"});return Y}}}}class nt{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t,ecosystem:i,passkeyDomain:r,storage:c}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passkeyDomain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const s=w("inAppWallet");this.client=e,this.ecosystem=i,this.passkeyDomain=r,this.storage=new V({clientId:e.clientId,ecosystem:i,storage:c??xe()}),this.querier=new _e({baseUrl:s,clientId:e.clientId,ecosystem:i}),this.auth=new Ne({baseUrl:s,client:e,ecosystem:i,localStorage:this.storage,onAuthSuccess:async a=>{if(t==null||t(a),a.storedToken.authDetails.walletType==="sharded"&&(await this.querier.call({params:{storedToken:a.storedToken},procedureName:"migrateFromShardToEnclave"})||console.warn("Failed to migrate from sharded to enclave wallet, continuing with sharded wallet")),this.wallet=await this.initializeWallet(a.storedToken.cookieString),!this.wallet)throw new Error("Failed to initialize wallet");const l="deviceShareStored"in a.walletDetails?a.walletDetails.deviceShareStored:void 0;return await this.wallet.postWalletSetUp({deviceShareStored:l,storedToken:a.storedToken}),this.wallet instanceof B&&await this.querier.call({params:{authCookie:a.storedToken.cookieString,clientId:this.client.clientId,deviceShareStored:"deviceShareStored"in a.walletDetails?a.walletDetails.deviceShareStored:null,ecosystemId:i==null?void 0:i.id,partnerId:i==null?void 0:i.partnerId,walletUserId:a.storedToken.authDetails.userWalletId},procedureName:"initIframe"}),{user:{account:await this.wallet.getAccount(),authDetails:a.storedToken.authDetails,status:"Logged In, Wallet Initialized",walletAddress:a.walletDetails.walletAddress}}},querier:this.querier})}async initializeWallet(e){var r;const t=await this.storage.getAuthCookie();if(!e&&t===null)throw new Error("No auth token provided and no stored auth token found to initialize the wallet");const i=await O({authToken:e||t,client:this.client,ecosystem:this.ecosystem});if(!i)throw new Error("Cannot initialize wallet, no user logged in");if(i.wallets.length===0)throw new Error("Cannot initialize wallet, this user does not have a wallet generated yet");return((r=i.wallets[0])==null?void 0:r.type)==="enclave"?new We({address:i.wallets[0].address,client:this.client,ecosystem:this.ecosystem,storage:this.storage}):new B({client:this.client,ecosystem:this.ecosystem,localStorage:this.storage,querier:this.querier})}async getUser(){if(!this.wallet){const e=await this.storage.getAuthCookie();if(!e)return{status:"Logged Out"};this.wallet=await this.initializeWallet(e)}if(!this.wallet)throw new Error("Wallet not initialized");return await this.wallet.getUserWalletStatus()}getAccount(){if(!this.wallet)throw new Error("Wallet not initialized");return this.wallet.getAccount()}async preAuthenticate(e){return ze({...e,client:this.client,ecosystem:this.ecosystem})}async authenticateWithRedirect(e,t,i){return Be({authOption:e,client:this.client,ecosystem:this.ecosystem,mode:t,redirectUrl:i})}async loginWithAuthToken(e,t){return this.auth.loginWithAuthToken(e,t)}async authenticate(e){const t=e.strategy;switch(t){case"email":return R({...e,client:this.client,ecosystem:this.ecosystem});case"phone":return R({...e,client:this.client,ecosystem:this.ecosystem});case"auth_endpoint":return he({client:this.client,ecosystem:this.ecosystem,payload:e.payload});case"jwt":return ge({client:this.client,ecosystem:this.ecosystem,jwt:e.jwt});case"passkey":return this.passkeyAuth(e);case"iframe_email_verification":return this.auth.authenticateWithIframe({email:e.email});case"iframe":return this.auth.authenticateWithModal();case"apple":case"facebook":case"google":case"telegram":case"github":case"twitch":case"farcaster":case"line":case"x":case"tiktok":case"steam":case"coinbase":case"discord":return Me({authOption:t,client:this.client,closeOpenedWindow:e.closeOpenedWindow,ecosystem:this.ecosystem,openedWindow:e.openedWindow});case"guest":return pe({client:this.client,ecosystem:this.ecosystem,storage:this.storage});case"backend":return we({client:this.client,ecosystem:this.ecosystem,walletSecret:e.walletSecret});case"wallet":return Te({client:this.client,ecosystem:this.ecosystem,wallet:e.wallet})}}async connect(e){const t=e.strategy;switch(t){case"auth_endpoint":case"jwt":{const i=await this.authenticate(e);return await this.loginWithAuthToken(i,e.encryptionKey)}case"iframe_email_verification":return this.auth.loginWithIframe({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{const i=await this.passkeyAuth(e);return this.loginWithAuthToken(i)}case"backend":case"phone":case"email":case"wallet":case"apple":case"facebook":case"google":case"farcaster":case"telegram":case"github":case"line":case"x":case"tiktok":case"guest":case"coinbase":case"twitch":case"steam":case"discord":{const i=await this.authenticate(e);return await this.auth.loginWithAuthToken(i)}default:Ge(t)}}async logout(){return await this.auth.logout()}async passkeyAuth(e){const{PasskeyWebClient:t}=await b(async()=>{const{PasskeyWebClient:a}=await import("./passkeys-BvJirJz0.js");return{PasskeyWebClient:a}},[]),{passkeyName:i,storeLastUsedPasskey:r=!0}=e,c=new t,s=this.storage;return e.type==="sign-up"?Ie({client:this.client,ecosystem:this.ecosystem,passkeyClient:c,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:r?s:void 0,username:i}):be({client:this.client,ecosystem:this.ecosystem,passkeyClient:c,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:r?s:void 0})}async linkProfile(e){const{storedToken:t}=await this.authenticate(e);return await me({client:e.client,ecosystem:e.ecosystem||this.ecosystem,storage:this.storage,tokenToLink:t.cookieString})}async unlinkProfile(e,t){return await fe({allowAccountDeletion:t,client:this.client,ecosystem:this.ecosystem,profileToUnlink:e,storage:this.storage})}async getProfiles(){return ye({client:this.client,ecosystem:this.ecosystem,storage:this.storage})}}function Ge(n,e){throw new Error(`Invalid param: ${n}`)}function xe(){return typeof window<"u"&&window.localStorage?x:oe}export{nt as InAppWebConnector};
