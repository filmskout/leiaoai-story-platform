import { ChatSession, ChatMessage } from '@/hooks/useAIChat';

/**
 * å°†èŠå¤©ä¼šè¯è½¬æ¢ä¸ºMarkdownæ ¼å¼
 */
export function sessionToMarkdown(session: ChatSession): string {
  const lines: string[] = [];
  
  // æ ‡é¢˜
  lines.push(`# ${session.title}`);
  lines.push('');
  
  // å…ƒæ•°æ®
  lines.push(`**åˆ›å»ºæ—¶é—´**: ${session.createdAt.toLocaleString('zh-CN')}`);
  lines.push(`**æ›´æ–°æ—¶é—´**: ${session.updatedAt.toLocaleString('zh-CN')}`);
  if (session.category) {
    lines.push(`**åˆ†ç±»**: ${session.category}`);
  }
  lines.push('');
  lines.push('---');
  lines.push('');
  
  // æ¶ˆæ¯å†…å®¹
  session.messages.forEach((message, index) => {
    if (message.role === 'user') {
      lines.push(`## ğŸ’¬ é—®é¢˜ ${Math.floor(index / 2) + 1}`);
      lines.push('');
      lines.push(message.content);
    } else {
      lines.push('');
      lines.push(`### ğŸ¤– å›ç­” (${message.aiModel || 'AI'})`);
      if (message.processingTime) {
        lines.push(`*å“åº”æ—¶é—´: ${(message.processingTime / 1000).toFixed(2)}ç§’*`);
      }
      lines.push('');
      lines.push(message.content);
    }
    lines.push('');
    lines.push('---');
    lines.push('');
  });
  
  // é¡µè„š
  lines.push(`*Generated by LeiaoAI on ${new Date().toLocaleString('zh-CN')}*`);
  
  return lines.join('\n');
}

/**
 * å°†Markdownå†…å®¹è½¬æ¢ä¸ºBlobï¼Œç”¨äºä¸‹è½½
 */
export function markdownToBlob(markdown: string): Blob {
  return new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
}

/**
 * ç”ŸæˆMarkdownæ–‡ä»¶åï¼ˆä»…ä½¿ç”¨è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼‰
 */
export function generateMarkdownFilename(session: ChatSession): string {
  const timestamp = session.createdAt.getTime();
  // ç§»é™¤æ‰€æœ‰éASCIIå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦
  const cleanTitle = session.title
    .replace(/[^a-zA-Z0-9_-]/g, '_')
    .replace(/_+/g, '_')  // å°†è¿ç»­çš„ä¸‹åˆ’çº¿æ›¿æ¢ä¸ºå•ä¸ª
    .replace(/^_|_$/g, '') // ç§»é™¤é¦–å°¾çš„ä¸‹åˆ’çº¿
    .substring(0, 50)
    || 'chat'; // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤åç§°
  return `${timestamp}_${cleanTitle}.md`;
}

/**
 * ä¸‹è½½Markdownæ–‡ä»¶
 */
export function downloadMarkdown(session: ChatSession): void {
  const markdown = sessionToMarkdown(session);
  const blob = markdownToBlob(markdown);
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = generateMarkdownFilename(session);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

