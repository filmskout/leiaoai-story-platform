const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/decimals-s0UCQKEI.js","assets/Auth-Da7edH4x.js","assets/index-BZnjROPM.js","assets/index-KhFIe2Wy.css","assets/mail-Dd9q-fNT.js","assets/eye-off-CTxfvyry.js","assets/eye-B3RkKAfO.js","assets/circle-alert-BkMsUCVY.js","assets/loader-circle-Cs0sZM6W.js","assets/read-contract-Cp90h2iM.js","assets/utils-BXRRhCbk.js","assets/to-serializable-transaction-CpnW1tN4.js","assets/signing-DWOPFmVm.js","assets/concat-hex-DPpLtwyv.js","assets/bundler-Ps6QYQUc.js","assets/addresses-Cbjra2SQ.js","assets/send-eip712-transaction-5lbJJuVE.js","assets/eth_sendRawTransaction-DPdnXbFR.js","assets/sha2-D3jwzLbD.js","assets/random-B1VyicZo.js","assets/send-transaction-DOA-1YsO.js","assets/in-app-wallet-calls-orMAWWKC.js","assets/wait-for-tx-receipt-CfzrCFqQ.js","assets/sleep-mAKpSMLY.js"])))=>i.map(i=>d[i]);
import{_ as x}from"./index-BZnjROPM.js";import{E as mt,i as W,x as z,av as K,aw as D,ax as C,D as j,al as S,g as ut,s as Z,a8 as _,ay as k,ae as H,a9 as O,az as pt,aA as yt,C as P,aB as lt,f as ft,aC as wt,aD as Y,aE as J,ad as At,aF as ht,c as Q,p as gt,b as I,t as V,aa as Gt,ab as Tt}from"./Auth-Da7edH4x.js";import{readContract as L}from"./read-contract-Cp90h2iM.js";import{g as vt,h as X,j as E,k as Pt,t as xt}from"./to-serializable-transaction-CpnW1tN4.js";import{p as F,o as tt,h as Lt,a as Ot,b as Dt,c as Ct,d as b,f as St,i as _t,j as Et}from"./bundler-Ps6QYQUc.js";import{Z as et}from"./addresses-Cbjra2SQ.js";import{t as Ft,p as It,s as Vt}from"./send-eip712-transaction-5lbJJuVE.js";import{r as bt}from"./random-B1VyicZo.js";import{s as Ut}from"./send-transaction-DOA-1YsO.js";import{e as Nt}from"./utils-BXRRhCbk.js";async function $t(e){const{factoryContract:a,predictAddressOverride:t,adminAddress:i,accountSalt:r,accountAddress:s}=e;if(t)return t(a,i);if(s)return s;if(!i)throw new Error("Account address is required to predict the smart wallet address.");return mt(async()=>{const c=r&&W(r)?r:z(r??"");let n,o=0;const d=3;for(;o<=d;)try{n=await L({contract:a,method:"function getAddress(address, bytes) returns (address)",params:[i,c]});break}catch(y){if(o===d)throw y;const l=2**(o+1)*200;await new Promise(m=>setTimeout(m,l)),o++}if(!n)throw new Error(`No smart account address found for admin address ${i} and salt ${r}`);return n},{cacheKey:`${e.factoryContract.chain.id}-${e.factoryContract.address}-${e.adminAddress}-${e.accountSalt}`,cacheTime:1e3*60*60*24})}function at(e){const{adminAddress:a,factoryContract:t,createAccountOverride:i,accountSalt:r}=e;if(i)return i(t,a);const s=r&&W(r)?r:z(r??"");return F({contract:t,method:"function createAccount(address, bytes) returns (address)",params:[a,s]})}function nt(e){const{accountContract:a,transaction:t,executeOverride:i}=e;if(i)return i(a,t);let r=t.value||0n;return(t.chainId===295||t.chainId===296)&&(r=BigInt(r)/BigInt(10**10)),F({contract:a,gas:t.gas?t.gas+21000n:void 0,method:"function execute(address, uint256, bytes)",params:[t.to||"",r,t.data||"0x"]})}function Rt(e){var c;const{accountContract:a,transactions:t,executeBatchOverride:i}=e;if(i)return i(a,t);let r=t.map(n=>n.value||0n);const s=(c=t[0])==null?void 0:c.chainId;return(s===295||s===296)&&(r=r.map(n=>BigInt(n)/BigInt(10**10))),F({contract:a,method:"function executeBatch(address[], uint256[], bytes[])",params:[t.map(n=>n.to||""),r,t.map(n=>n.data||"0x")]})}const kt="0xdd62ed3e",Ht=[{name:"owner",type:"address"},{name:"spender",type:"address"}],Bt=[{type:"uint256"}];async function Mt(e){return L({contract:e.contract,method:[kt,Ht,Bt],params:[e.owner,e.spender]})}const qt="0x095ea7b3",Wt=[{name:"spender",type:"address"},{name:"value",type:"uint256"}],zt=[{type:"bool"}];function Kt(e){const a=tt(async()=>"asyncParams"in e?await e.asyncParams():e);return F({accessList:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.accessList},authorizationList:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.authorizationList},contract:e.contract,erc20Value:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.erc20Value},extraGas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.extraGas},gas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.gas},gasPrice:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.gasPrice},maxFeePerGas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.maxFeePerGas},maxPriorityFeePerGas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.maxPriorityFeePerGas},method:[qt,Wt,zt],nonce:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.nonce},params:async()=>{const t=await a();return[t.spender,t.value]},value:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.value}})}function jt(e){return Kt({asyncParams:async()=>{let a;if("amount"in e){const{decimals:t}=await x(async()=>{const{decimals:r}=await import("./decimals-s0UCQKEI.js");return{decimals:r}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),i=await t(e).catch(()=>18);a=vt(e.amount.toString(),i)}else a=e.amountWei;return{overrides:{erc20Value:{amountWei:a,tokenAddress:e.contract.address},...e.overrides},spender:e.spender,value:a}},contract:e.contract})}const Zt="0xf15d424e",Yt=[{name:"signer",type:"address"}],Jt=[{components:[{name:"signer",type:"address"},{name:"approvedTargets",type:"address[]"},{name:"nativeTokenLimitPerTransaction",type:"uint256"},{name:"startTimestamp",type:"uint128"},{name:"endTimestamp",type:"uint128"}],name:"permissions",type:"tuple"}];async function Qt(e){return L({contract:e.contract,method:[Zt,Yt,Jt],params:[e.signer]})}const Xt="0x5892e236",te=[{components:[{name:"signer",type:"address"},{name:"isAdmin",type:"uint8"},{name:"approvedTargets",type:"address[]"},{name:"nativeTokenLimitPerTransaction",type:"uint256"},{name:"permissionStartTimestamp",type:"uint128"},{name:"permissionEndTimestamp",type:"uint128"},{name:"reqValidityStartTimestamp",type:"uint128"},{name:"reqValidityEndTimestamp",type:"uint128"},{name:"uid",type:"bytes32"}],name:"req",type:"tuple"},{name:"signature",type:"bytes"}],ee=[];function ae(e){const a=tt(async()=>"asyncParams"in e?await e.asyncParams():e);return F({accessList:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.accessList},authorizationList:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.authorizationList},contract:e.contract,erc20Value:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.erc20Value},extraGas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.extraGas},gas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.gas},gasPrice:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.gasPrice},maxFeePerGas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.maxFeePerGas},maxPriorityFeePerGas:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.maxPriorityFeePerGas},method:[Xt,te,ee],nonce:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.nonce},params:async()=>{const t=await a();return[t.req,t.signature]},value:async()=>{var t;return(t=(await a()).overrides)==null?void 0:t.value}})}function q(){return new Date(Date.now()+1e3*60*60*24*365*10)}function N(e){return Ft(Math.floor(e.getTime()/1e3))}const ne=[{name:"signer",type:"address"},{name:"isAdmin",type:"uint8"},{name:"approvedTargets",type:"address[]"},{name:"nativeTokenLimitPerTransaction",type:"uint256"},{name:"permissionStartTimestamp",type:"uint128"},{name:"permissionEndTimestamp",type:"uint128"},{name:"reqValidityStartTimestamp",type:"uint128"},{name:"reqValidityEndTimestamp",type:"uint128"},{name:"uid",type:"bytes32"}];async function se(e){const{account:a,contract:t,req:i}=e,r=await a.signTypedData({domain:{chainId:t.chain.id,name:"Account",verifyingContract:t.address,version:"1"},message:i,primaryType:"SignerPermissionRequest",types:{SignerPermissionRequest:ne}});return{req:i,signature:r}}async function re(e){var i;const{target:a,permissions:t}=e;return{approvedTargets:t.approvedTargets==="*"?[et]:t.approvedTargets,isAdmin:0,nativeTokenLimitPerTransaction:X(((i=t.nativeTokenLimitPerTransaction)==null?void 0:i.toString())||"0"),permissionEndTimestamp:N(t.permissionEndTimestamp||q()),permissionStartTimestamp:N(t.permissionStartTimestamp||new Date(0)),reqValidityEndTimestamp:N(q()),reqValidityStartTimestamp:0n,signer:a,uid:await bt()}}function ie(e){const{contract:a,sessionKeyAddress:t,account:i,permissions:r}=e;return ae({async asyncParams(){const{req:s,signature:c}=await se({account:i,contract:a,req:await re({permissions:r,target:t})});return{req:s,signature:c}},contract:a})}async function ce(e){var c;const{accountContract:a,sessionKeyAddress:t,newPermissions:i}=e;if(!await K(a))return!0;const s=await Qt({contract:a,signer:t});return!!(s.endTimestamp&&s.endTimestamp<Math.floor(Date.now()/1e3)||!oe(s.approvedTargets,i.approvedTargets)||X(((c=i.nativeTokenLimitPerTransaction)==null?void 0:c.toString())??"0")>s.nativeTokenLimitPerTransaction)}function oe(e,a){return a==="*"&&e.length===1&&e[0]===et?!0:a!=="*"?a.map(t=>t.toLowerCase()).every(t=>e.map(i=>i.toLowerCase()).includes(t)):!1}const de=2n**96n-1n,me="0x35567e1a",ue=[{name:"sender",type:"address"},{name:"key",type:"uint192"}],pe=[{name:"nonce",type:"uint256"}];async function ye(e){return L({contract:e.contract,method:[me,ue,pe],params:[e.sender,e.key]})}const le="0xa6193531",fe=[{components:[{name:"sender",type:"address"},{name:"nonce",type:"uint256"},{name:"initCode",type:"bytes"},{name:"callData",type:"bytes"},{name:"callGasLimit",type:"uint256"},{name:"verificationGasLimit",type:"uint256"},{name:"preVerificationGas",type:"uint256"},{name:"maxFeePerGas",type:"uint256"},{name:"maxPriorityFeePerGas",type:"uint256"},{name:"paymasterAndData",type:"bytes"},{name:"signature",type:"bytes"}],name:"userOp",type:"tuple"}],we=[{type:"bytes32"}];async function Ae(e){return L({contract:e.contract,method:[le,fe,we],params:[e.userOp]})}const he="0x22cdde4c",ge=[{components:[{name:"sender",type:"address"},{name:"nonce",type:"uint256"},{name:"initCode",type:"bytes"},{name:"callData",type:"bytes"},{name:"accountGasLimits",type:"bytes32"},{name:"preVerificationGas",type:"uint256"},{name:"gasFees",type:"bytes32"},{name:"paymasterAndData",type:"bytes"},{name:"signature",type:"bytes"}],name:"userOp",type:"tuple"}],Ge=[{type:"bytes32"}];async function Te(e){return L({contract:e.contract,method:[he,ge,Ge],params:[e.userOp]})}function ve(e){return e.factory?E([e.factory,e.factoryData||"0x"]):"0x"}function Pe(e){return E([D(C(BigInt(e.verificationGasLimit)),{size:16}),D(C(BigInt(e.callGasLimit)),{size:16})])}function xe(e){return E([D(C(BigInt(e.maxPriorityFeePerGas)),{size:16}),D(C(BigInt(e.maxFeePerGas)),{size:16})])}function Le(e){return e.paymaster?E([e.paymaster,D(C(BigInt(e.paymasterVerificationGasLimit||0)),{size:16}),D(C(BigInt(e.paymasterPostOpGasLimit||0)),{size:16}),e.paymasterData||"0x"]):"0x"}const Oe=e=>({accountGasLimits:Pe(e),callData:e.callData,gasFees:xe(e),initCode:ve(e),nonce:BigInt(e.nonce),paymasterAndData:Le(e),preVerificationGas:BigInt(e.preVerificationGas),sender:e.sender,signature:e.signature});async function U(e){var A;const{userOp:a,paymasterOverride:t,client:i,chain:r,entrypointAddress:s}=e;if(t)return t(a);const c={"Content-Type":"application/json"},n=s??S,o=j(r),d={id:1,jsonrpc:"2.0",method:"pm_sponsorUserOperation",params:[Lt(a),n]},l=await ut(i)(o,{body:Z(d),headers:c,method:"POST"});if(!l.ok){const h=await l.text()||l.statusText;throw new Error(`Paymaster error: ${l.status} - ${h}`)}const m=await l.json();if(m.result)return typeof m.result=="string"?{paymasterAndData:m.result}:(m.result.reason&&console.warn(`Paymaster policy rejected this transaction with reason: ${m.result.reason} ${m.result.policyId?`(policyId: ${m.result.policyId})`:""}`),{callGasLimit:m.result.callGasLimit?_(m.result.callGasLimit):void 0,paymaster:m.result.paymaster,paymasterAndData:m.result.paymasterAndData,paymasterData:m.result.paymasterData,paymasterPostOpGasLimit:m.result.paymasterPostOpGasLimit?_(m.result.paymasterPostOpGasLimit):void 0,paymasterVerificationGasLimit:m.result.paymasterVerificationGasLimit?_(m.result.paymasterVerificationGasLimit):void 0,preVerificationGas:m.result.preVerificationGas?_(m.result.preVerificationGas):void 0,verificationGasLimit:m.result.verificationGasLimit?_(m.result.verificationGasLimit):void 0});const w=((A=m.error)==null?void 0:A.message)||m.error||l.statusText||"unknown error";throw new Error(`Paymaster error from ${o}: ${w}`)}const B=new Set,M=e=>`${e.chain.id}:${e.address}`,st=e=>{B.add(M(e))},rt=e=>{B.delete(M(e))},it=e=>B.has(M(e));async function De(e){const a=e.timeoutMs||12e4,t=e.intervalMs||1e3,i=Date.now()+a;for(;Date.now()<i;){const r=await Ot(e);if(r)return r;await new Promise(s=>setTimeout(s,t))}throw new Error(`Timeout waiting for userOp to be mined on chain ${e.chain.id} with UserOp hash: ${e.userOpHash}`)}async function Ce(e){var T;const{transaction:a,accountContract:t,factoryContract:i,adminAddress:r,overrides:s,sponsorGas:c,waitForDeployment:n=!0,isDeployedOverride:o}=e,d=a.chain,y=a.client,l={bundlerUrl:s==null?void 0:s.bundlerUrl,chain:d,client:y,entrypointAddress:s==null?void 0:s.entrypointAddress},m=k(((T=e.overrides)==null?void 0:T.entrypointAddress)||S),[w,A,h,g,f]=await Promise.all([typeof o=="boolean"?o:K(t).then(G=>G||it(t)),H(a),O(a.gas),Se({bundlerOptions:l,chain:d,client:y,executeTx:a}),be({accountContract:t,chain:d,client:y,entrypointAddress:s==null?void 0:s.entrypointAddress,getNonceOverride:s==null?void 0:s.getAccountNonce})]),{maxFeePerGas:u,maxPriorityFeePerGas:p}=g;return m==="v0.7"?_e({accountContract:t,adminAddress:r,bundlerOptions:l,callData:A,callGasLimit:h,factoryContract:i,isDeployed:w,maxFeePerGas:u,maxPriorityFeePerGas:p,nonce:f,overrides:s,sponsorGas:c,waitForDeployment:n}):Ee({accountContract:t,adminAddress:r,bundlerOptions:l,callData:A,callGasLimit:h,factoryContract:i,isDeployed:w,maxFeePerGas:u,maxPriorityFeePerGas:p,nonce:f,overrides:s,sponsorGas:c,waitForDeployment:n})}async function Se(e){const{executeTx:a,bundlerOptions:t,chain:i,client:r}=e;let{maxFeePerGas:s,maxPriorityFeePerGas:c}=a;const n=(t==null?void 0:t.bundlerUrl)??j(i);if(yt(n)){const o=await Dt({options:t});s=o.maxFeePerGas,c=o.maxPriorityFeePerGas}else{const[o,d]=await Promise.all([O(s),O(c)]);if(o&&d)s=o,c=d;else{const y=await Pt(r,i);c=d??y.maxPriorityFeePerGas??0n,s=o??y.maxFeePerGas??0n}}return{maxFeePerGas:s,maxPriorityFeePerGas:c}}async function _e(e){const{bundlerOptions:a,isDeployed:t,factoryContract:i,accountContract:r,adminAddress:s,sponsorGas:c,overrides:n,nonce:o,callData:d,callGasLimit:y,maxFeePerGas:l,maxPriorityFeePerGas:m,waitForDeployment:w}=e,{chain:A,client:h}=a;let g,f;t?(f="0x",w&&await ct(r)):(g=i.address,f=await H(at({accountSalt:n==null?void 0:n.accountSalt,adminAddress:s,createAccountOverride:n==null?void 0:n.createAccount,factoryContract:i})),w&&st(r));const u={callData:d,callGasLimit:y??0n,factory:g,factoryData:f,maxFeePerGas:l,maxPriorityFeePerGas:m,nonce:o,paymaster:void 0,paymasterData:"0x",paymasterPostOpGasLimit:0n,paymasterVerificationGasLimit:0n,preVerificationGas:0n,sender:r.address,signature:Y,verificationGasLimit:0n};if(c){const p=await U({chain:A,client:h,entrypointAddress:n==null?void 0:n.entrypointAddress,paymasterOverride:n==null?void 0:n.paymaster,userOp:u});if(p.paymaster&&p.paymasterData&&(u.paymaster=p.paymaster,u.paymasterData=p.paymasterData),p.callGasLimit&&p.verificationGasLimit&&p.preVerificationGas&&p.paymasterPostOpGasLimit&&p.paymasterVerificationGasLimit)u.callGasLimit=p.callGasLimit,u.verificationGasLimit=p.verificationGasLimit,u.preVerificationGas=p.preVerificationGas,u.paymasterPostOpGasLimit=p.paymasterPostOpGasLimit,u.paymasterVerificationGasLimit=p.paymasterVerificationGasLimit;else{const T=n!=null&&n.tokenPaymaster?{[n.tokenPaymaster.tokenAddress]:{stateDiff:{[lt(Nt([{type:"address"},{type:"uint256"}],[r.address,n.tokenPaymaster.balanceStorageSlot]))]:ft(wt,{size:32})}}}:void 0,G=await b({options:a,userOp:u},T);u.callGasLimit=G.callGasLimit,u.verificationGasLimit=G.verificationGasLimit,u.preVerificationGas=G.preVerificationGas,u.paymasterPostOpGasLimit=n!=null&&n.tokenPaymaster?500000n:G.paymasterPostOpGasLimit||0n,u.paymasterVerificationGasLimit=G.paymasterVerificationGasLimit||0n;const v=await U({chain:A,client:h,entrypointAddress:n==null?void 0:n.entrypointAddress,paymasterOverride:n==null?void 0:n.paymaster,userOp:u});v.paymaster&&v.paymasterData&&(u.paymaster=v.paymaster,u.paymasterData=v.paymasterData)}}else{const p=await b({options:a,userOp:u});u.callGasLimit=p.callGasLimit,u.verificationGasLimit=p.verificationGasLimit,u.preVerificationGas=p.preVerificationGas,u.paymasterPostOpGasLimit=p.paymasterPostOpGasLimit||0n,u.paymasterVerificationGasLimit=p.paymasterVerificationGasLimit||0n}return{...u,signature:"0x"}}async function Ee(e){const{bundlerOptions:a,isDeployed:t,factoryContract:i,accountContract:r,adminAddress:s,sponsorGas:c,overrides:n,nonce:o,callData:d,callGasLimit:y,maxFeePerGas:l,maxPriorityFeePerGas:m,waitForDeployment:w}=e,{chain:A,client:h}=a;let g;t?(g="0x",w&&await ct(r)):(g=await Ve({accountSalt:n==null?void 0:n.accountSalt,adminAddress:s,createAccountOverride:n==null?void 0:n.createAccount,factoryContract:i}),w&&st(r));const f={callData:d,callGasLimit:y??0n,initCode:g,maxFeePerGas:l,maxPriorityFeePerGas:m,nonce:o,paymasterAndData:"0x",preVerificationGas:0n,sender:r.address,signature:Y,verificationGasLimit:0n};if(c){const u=await U({chain:A,client:h,entrypointAddress:n==null?void 0:n.entrypointAddress,paymasterOverride:n==null?void 0:n.paymaster,userOp:f}),p="paymasterAndData"in u?u.paymasterAndData:"0x";if(p&&p!=="0x"&&(f.paymasterAndData=p),u.callGasLimit&&u.verificationGasLimit&&u.preVerificationGas)f.callGasLimit=u.callGasLimit,f.verificationGasLimit=u.verificationGasLimit,f.preVerificationGas=u.preVerificationGas;else{const T=await b({options:a,userOp:f});if(f.callGasLimit=T.callGasLimit,f.verificationGasLimit=T.verificationGasLimit,f.preVerificationGas=T.preVerificationGas,p&&p!=="0x"){const G=await U({chain:A,client:h,entrypointAddress:n==null?void 0:n.entrypointAddress,paymasterOverride:n==null?void 0:n.paymaster,userOp:f}),v="paymasterAndData"in G?G.paymasterAndData:"0x";v&&v!=="0x"&&(f.paymasterAndData=v)}}}else{const u=await b({options:a,userOp:f});f.callGasLimit=u.callGasLimit,f.verificationGasLimit=u.verificationGasLimit,f.preVerificationGas=u.preVerificationGas}return{...f,signature:"0x"}}async function Fe(e){const{userOp:a,chain:t,entrypointAddress:i,adminAccount:r}=e,s=await Ie({chain:t,client:e.client,entrypointAddress:i,userOp:a});if(r.signMessage){const c=await r.signMessage({chainId:t.id,message:{raw:pt(s)},originalMessage:Z(a)});return{...a,signature:c}}throw new Error("signMessage not implemented in signingAccount")}async function Ie(e){const{userOp:a,chain:t,entrypointAddress:i}=e,r=k(i||S);let s;if(r==="v0.7"){const c=Oe(a);s=await Te({contract:P({address:i||J,chain:t,client:e.client}),userOp:c})}else s=await Ae({contract:P({address:i||S,chain:t,client:e.client}),userOp:a});return s}async function Ve(e){const{factoryContract:a,adminAddress:t,accountSalt:i,createAccountOverride:r}=e,s=at({accountSalt:i,adminAddress:t,createAccountOverride:r,factoryContract:a});return E([a.address,await H(s)])}async function be(e){const{accountContract:a,chain:t,client:i,entrypointAddress:r,getNonceOverride:s}=e;return s?s(a):await ye({contract:P({address:r||S,chain:t,client:i}),key:Ct(),sender:a.address})}async function ct(e){const a=Date.now();for(;it(e);){if(Date.now()-a>6e4)throw rt(e),new Error("Account deployment is taking too long (over 1 minute). Please try again.");await new Promise(t=>setTimeout(t,500))}}const ot=new WeakMap,$=new WeakMap;async function Ue(e,a){var m,w,A,h,g,f,u;const{personalAccount:t,client:i}=e;if(!t)throw new Error("No personal account provided for smart account connection");const r=a,s=a.chain,c="gasless"in r?r.gasless:r.sponsorGas;if(await At(s))return[ke({chain:s,connectionOptions:e,creationOptions:a,sponsorGas:c}),s];if(r.factoryAddress&&!((m=r.overrides)!=null&&m.entrypointAddress)){const p=await dt(r.factoryAddress,i,s);p&&(r.overrides={...r.overrides,entrypointAddress:p})}(w=r.overrides)!=null&&w.tokenPaymaster&&!((A=r.overrides)!=null&&A.entrypointAddress)&&(r.overrides={...r.overrides,entrypointAddress:J});const n=r.factoryAddress??ht((h=r.overrides)==null?void 0:h.entrypointAddress),o=P({address:n,chain:s,client:i}),d=await $t({accountAddress:(g=r.overrides)==null?void 0:g.accountAddress,accountSalt:(f=r.overrides)==null?void 0:f.accountSalt,adminAddress:t.address,factoryContract:o,predictAddressOverride:(u=r.overrides)==null?void 0:u.predictAddress}).then(p=>p).catch(p=>{throw new Error(`Failed to get account address with factory contract ${o.address} on chain ID ${s.id}: ${(p==null?void 0:p.message)||"unknown error"}`,{cause:p})}),y=P({address:d,chain:s,client:i}),l=await $e({...r,accountContract:y,chain:s,client:i,factoryContract:o,personalAccount:t,sponsorGas:c});if(ot.set(t,l),$.set(l,t),r.sessionKey&&await ce({accountContract:y,newPermissions:r.sessionKey.permissions,sessionKeyAddress:r.sessionKey.address})){const p=ie({account:t,contract:y,permissions:r.sessionKey.permissions,sessionKeyAddress:r.sessionKey.address});await Ut({account:l,transaction:p})}return[l,s]}async function Ne(e){const a=$.get(e);a&&(ot.delete(a),$.delete(e))}async function $e(e){var s,c;const a=(s=e.overrides)==null?void 0:s.tokenPaymaster;if(a&&k(((c=e.overrides)==null?void 0:c.entrypointAddress)||S)!=="v0.7")throw new Error("Token paymaster is only supported for entrypoint version v0.7");const t=e.sponsorGas;let i=e.accountContract;const r={address:Q(i.address),async onTransactionRequested(n){var o,d;return(d=(o=e.personalAccount).onTransactionRequested)==null?void 0:d.call(o,n)},async sendBatchTransaction(n){var m,w;const o=Rt({accountContract:i,executeBatchOverride:(m=e.overrides)==null?void 0:m.executeBatch,transactions:n});if(n.length===0)throw new Error("No transactions to send");const d=n[0];if(!d)throw new Error("No transactions to send");const y=I(d.chainId),l=await R({executeTx:o,options:{...e,accountContract:i,chain:y}});return V({chainId:y.id,client:e.client,contractAddress:((w=n[0])==null?void 0:w.to)??void 0,transactionHash:l.transactionHash,walletAddress:e.accountContract.address,walletType:"smart"}),l},async sendTransaction(n){var m,w,A;let o;if(a){await Re({accountContract:i,erc20Paymaster:a,options:e});const h=async()=>({paymaster:a.paymasterAddress,paymasterData:"0x"});o=((m=e.overrides)==null?void 0:m.paymaster)||h}else o=(w=e.overrides)==null?void 0:w.paymaster;n.chainId!==i.chain.id&&(i=P({address:r.address,chain:I(n.chainId),client:e.client}));const d=nt({accountContract:i,executeOverride:(A=e.overrides)==null?void 0:A.execute,transaction:n}),y=I(n.chainId),l=await R({executeTx:d,options:{...e,accountContract:i,chain:y,overrides:{...e.overrides,paymaster:o}}});return V({chainId:y.id,client:e.client,contractAddress:n.to??void 0,transactionHash:l.transactionHash,walletAddress:e.accountContract.address,walletType:"smart"}),l},async signMessage({message:n}){var d;if((d=e.overrides)!=null&&d.signMessage)return e.overrides.signMessage({accountContract:i,adminAccount:e.personalAccount,factoryContract:e.factoryContract,message:n});const{smartAccountSignMessage:o}=await x(async()=>{const{smartAccountSignMessage:y}=await import("./signing-DWOPFmVm.js");return{smartAccountSignMessage:y}},__vite__mapDeps([12,10,1,2,3,4,5,6,7,8,11,13,9,14,15,16,17,18,19,20]));return o({accountContract:i,factoryContract:e.factoryContract,message:n,options:e})},async signTypedData(n){var d;if((d=e.overrides)!=null&&d.signTypedData)return e.overrides.signTypedData({accountContract:i,adminAccount:e.personalAccount,factoryContract:e.factoryContract,typedData:n});const{smartAccountSignTypedData:o}=await x(async()=>{const{smartAccountSignTypedData:y}=await import("./signing-DWOPFmVm.js");return{smartAccountSignTypedData:y}},__vite__mapDeps([12,10,1,2,3,4,5,6,7,8,11,13,9,14,15,16,17,18,19,20]));return o({accountContract:i,factoryContract:e.factoryContract,options:e,typedData:n})},sendCalls:async n=>{const{inAppWalletSendCalls:o}=await x(async()=>{const{inAppWalletSendCalls:w}=await import("./in-app-wallet-calls-orMAWWKC.js");return{inAppWalletSendCalls:w}},__vite__mapDeps([21,22,1,2,3,4,5,6,7,8,11,23,20,19])),d=n.calls[0];if(!d)throw new Error("No calls to send");const y=d.client,l=d.chain||n.chain,m=await o({account:r,calls:n.calls});return{chain:l,client:y,id:m}},getCallsStatus:async n=>{const{inAppWalletGetCallsStatus:o}=await x(async()=>{const{inAppWalletGetCallsStatus:d}=await import("./in-app-wallet-calls-orMAWWKC.js");return{inAppWalletGetCallsStatus:d}},__vite__mapDeps([21,22,1,2,3,4,5,6,7,8,11,23,20,19]));return o(n)},getCapabilities:async n=>({[n.chainId??1]:{atomic:{status:"supported"},paymasterService:{supported:t??!1}}})};return r}async function Re(e){var y;const{accountContract:a,erc20Paymaster:t,options:i}=e,r=t.tokenAddress,s=P({address:r,chain:a.chain,client:a.client});if(await Mt({contract:s,owner:a.address,spender:t.paymasterAddress})>0n)return;const n=jt({amountWei:de-1n,contract:s,spender:t.paymasterAddress}),o=await xt({from:a.address,transaction:n}),d=nt({accountContract:a,executeOverride:(y=i.overrides)==null?void 0:y.execute,transaction:o});await R({executeTx:d,options:{...i,overrides:{...i.overrides,tokenPaymaster:void 0}}})}function ke(e){const{creationOptions:a,connectionOptions:t,chain:i}=e,r={address:Q(t.personalAccount.address),async onTransactionRequested(s){var c,n;return(n=(c=t.personalAccount).onTransactionRequested)==null?void 0:n.call(c,s)},async sendTransaction(s){var y,l,m,w;const c={chain:I(s.chainId),client:t.client,data:s.data,eip712:s.eip712,to:s.to??void 0,value:s.value??0n};let n=await It({account:r,transaction:c});if(e.sponsorGas&&!n.paymaster){const A=await St({options:{bundlerUrl:(y=a.overrides)==null?void 0:y.bundlerUrl,chain:i,client:t.client,entrypointAddress:(l=a.overrides)==null?void 0:l.entrypointAddress},transaction:n});n={...n,...A}}const o=await Vt({account:r,chainId:i.id,eip712Transaction:n}),d=await _t({options:{bundlerUrl:(m=a.overrides)==null?void 0:m.bundlerUrl,chain:i,client:t.client,entrypointAddress:(w=a.overrides)==null?void 0:w.entrypointAddress},signedTransaction:o,transaction:n});return V({chainId:i.id,client:t.client,contractAddress:s.to??void 0,transactionHash:d.transactionHash,walletAddress:r.address,walletType:"smart"}),{chain:i,client:t.client,transactionHash:d.transactionHash}},async signMessage({message:s}){return t.personalAccount.signMessage({message:s})},async signTypedData(s){const c=gt(s);return t.personalAccount.signTypedData(c)},sendCalls:async s=>{const{inAppWalletSendCalls:c}=await x(async()=>{const{inAppWalletSendCalls:l}=await import("./in-app-wallet-calls-orMAWWKC.js");return{inAppWalletSendCalls:l}},__vite__mapDeps([21,22,1,2,3,4,5,6,7,8,11,23,20,19])),n=s.calls[0];if(!n)throw new Error("No calls to send");const o=n.client,d=n.chain||s.chain,y=await c({account:r,calls:s.calls});return{chain:d,client:o,id:y}},getCallsStatus:async s=>{const{inAppWalletGetCallsStatus:c}=await x(async()=>{const{inAppWalletGetCallsStatus:n}=await import("./in-app-wallet-calls-orMAWWKC.js");return{inAppWalletGetCallsStatus:n}},__vite__mapDeps([21,22,1,2,3,4,5,6,7,8,11,23,20,19]));return c(s)},getCapabilities:async s=>({[s.chainId??1]:{atomic:{status:"unsupported"},paymasterService:{supported:e.sponsorGas??!1}}})};return r}async function R(e){var i,r,s;const{executeTx:a,options:t}=e;try{const c=await Ce({accountContract:t.accountContract,adminAddress:t.personalAccount.address,factoryContract:t.factoryContract,overrides:t.overrides,sponsorGas:t.sponsorGas,transaction:a}),n=await Fe({adminAccount:t.personalAccount,chain:t.chain,client:t.client,entrypointAddress:(i=t.overrides)==null?void 0:i.entrypointAddress,userOp:c}),o={bundlerUrl:(r=t.overrides)==null?void 0:r.bundlerUrl,chain:t.chain,client:t.client,entrypointAddress:(s=t.overrides)==null?void 0:s.entrypointAddress},d=await Et({options:o,userOp:n}),y=await De({...o,userOpHash:d});return V({chainId:t.chain.id,client:t.client,contractAddress:await O(a.to??void 0),transactionHash:y.transactionHash,walletAddress:t.accountContract.address,walletType:"smart"}),{chain:t.chain,client:t.client,transactionHash:y.transactionHash}}catch(c){throw Gt(c)&&Tt({chainId:t.chain.id,client:t.client,contractAddress:await O(a.to??void 0),error:c,transactionValue:await O(a.value),walletAddress:t.accountContract.address}),c}finally{rt(t.accountContract)}}async function dt(e,a,t){const i=P({address:e,chain:t,client:a});try{return await L({contract:i,method:"function entrypoint() public view returns (address)"})}catch{return}}const Je=Object.freeze(Object.defineProperty({__proto__:null,connectSmartAccount:Ue,disconnectSmartAccount:Ne,getEntrypointFromFactory:dt},Symbol.toStringTag,{value:"Module"}));export{Je as i,at as p};
